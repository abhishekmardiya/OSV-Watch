import type { Metadata } from "next";
import { Suspense } from "react";
import { VulnerabilityDetailContent } from "@/components/VulnerabilityDetailContent";
import { VulnerabilityDetailShimmer } from "@/components/VulnerabilityDetailShimmer";
import { getVulnerabilityById } from "@/server";
import type { VulnerabilityPageProps } from "@/types";

const BASE_URL = "https://osv-watch.vercel.app";

export async function generateMetadata({
  params,
}: VulnerabilityPageProps): Promise<Metadata> {
  const { id } = await params;
  const decodedId = decodeURIComponent(id);
  const { vulnerability } = await getVulnerabilityById(decodedId);

  const cveId =
    vulnerability?.aliases?.find((alias) => alias.startsWith("CVE-")) ||
    vulnerability?.id ||
    decodedId;
  const title = vulnerability
    ? `${cveId} - ${vulnerability.summary || "Security Vulnerability"} | OSV Watch`
    : `Vulnerability ${decodedId} | OSV Watch`;
  const description = vulnerability?.summary
    ? `${vulnerability.summary} - View detailed information about this security vulnerability on OSV Watch.`
    : `View detailed information about security vulnerability ${decodedId} on OSV Watch.`;
  const url = `${BASE_URL}/vulnerability/${encodeURIComponent(decodedId)}`;

  return {
    title,
    description,
    alternates: {
      canonical: url,
    },
  };
}

export default async function VulnerabilityPage({
  params,
}: VulnerabilityPageProps) {
  const paramsData = params.then((p) => ({
    id: decodeURIComponent(p.id),
  }));

  return (
    <main className="min-h-screen bg-linear-to-br from-slate-50 via-blue-50/30 to-purple-50/20 dark:from-gray-900 dark:via-blue-950/20 dark:to-purple-950/20 py-8 px-4 sm:px-6 lg:px-8">
      <div className="max-w-5xl mx-auto">
        <Suspense fallback={<VulnerabilityDetailShimmer />}>
          <VulnerabilityDetailContent params={paramsData} />
        </Suspense>
      </div>
    </main>
  );
}
