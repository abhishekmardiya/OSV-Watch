import Link from "next/link";
import {
  HiArrowPath,
  HiArrowTopRightOnSquare,
  HiCalendar,
  HiCube,
  HiXMark,
} from "react-icons/hi2";
import ReactMarkdown from "react-markdown";
import rehypeRaw from "rehype-raw";
import remarkGfm from "remark-gfm";
import { CVSSEducationModal } from "@/components/CVSSEducationModal";
import type { VulnerabilityCardProps } from "@/types";
import {
  formatCVSSVector,
  formatDate,
  formatVersionRange,
  getCVSSScore,
  getSeverityColor,
  getSeverityColorFromString,
  getSeverityFromDatabaseSpecific,
  getSeverityLabel,
} from "@/utils";

export const VulnerabilityDetail = ({
  vulnerability,
}: VulnerabilityCardProps) => {
  const databaseSeverity = getSeverityFromDatabaseSpecific(
    vulnerability.database_specific
  );
  const severityColor = databaseSeverity
    ? getSeverityColorFromString(databaseSeverity)
    : getSeverityColor(vulnerability.severity);
  const severityLabel = getSeverityLabel(
    vulnerability.severity,
    databaseSeverity
  );
  const cveId =
    vulnerability.aliases?.find((alias) => alias.startsWith("CVE-")) ||
    vulnerability.id;
  const publishedDate = formatDate(vulnerability.published);
  const modifiedDate = formatDate(vulnerability.modified);

  return (
    <div className="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200/50 dark:border-gray-700/50 p-8">
      <div className="mb-6 pb-6 border-b border-gray-200 dark:border-gray-700">
        <div className="flex items-center gap-4 flex-wrap mb-4">
          <div className={`w-3 h-3 rounded-full shrink-0 ${severityColor}`} />
          <h1 className="text-xl sm:text-3xl font-bold text-gray-900 dark:text-white">
            {cveId || vulnerability.id || "Unknown ID"}
          </h1>
        </div>
        {vulnerability.summary && (
          <p className="text-lg text-gray-700 dark:text-gray-300">
            {vulnerability.summary}
          </p>
        )}
        <div className="flex items-center flex-wrap gap-6 mt-4 text-sm text-gray-500 dark:text-gray-500">
          <span className="flex items-center gap-1">
            <HiCalendar className="w-4 h-4" aria-label="Published date" />
            Published: {publishedDate}
          </span>
          {modifiedDate !== publishedDate && (
            <span className="flex items-center gap-1">
              <HiArrowPath className="w-4 h-4" aria-label="Modified date" />
              Modified: {modifiedDate}
            </span>
          )}
          {vulnerability.withdrawn && (
            <span className="flex items-center gap-1 text-red-600 dark:text-red-400">
              <HiXMark className="w-4 h-4" aria-label="Withdrawn" />
              Withdrawn: {formatDate(vulnerability.withdrawn)}
            </span>
          )}
        </div>
      </div>

      <div className="space-y-6">
        {databaseSeverity && (
          <div>
            <h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-3">
              Severity
            </h2>
            <div className="flex items-center gap-2">
              <span
                className={`px-4 py-2 rounded-lg text-xs font-medium text-white ${severityColor}`}
              >
                {severityLabel}
              </span>
            </div>
          </div>
        )}

        {vulnerability.severity && !!vulnerability?.severity?.length && (
          <div>
            <div className="flex items-center gap-2 mb-3">
              <h2 className="text-xl font-semibold text-gray-900 dark:text-white">
                CVSS Scores
              </h2>
              <CVSSEducationModal />
            </div>
            <div className="space-y-4">
              {vulnerability.severity.map((severityItem, index) => {
                const cvssScore = getCVSSScore(severityItem?.score);
                const scoreColor =
                  cvssScore !== null
                    ? cvssScore >= 9.0
                      ? "bg-red-600"
                      : cvssScore >= 7.0
                        ? "bg-orange-600"
                        : cvssScore >= 4.0
                          ? "bg-yellow-500"
                          : "bg-blue-500"
                    : "bg-gray-500";

                const borderColor =
                  cvssScore !== null
                    ? cvssScore >= 9.0
                      ? "border-l-red-600"
                      : cvssScore >= 7.0
                        ? "border-l-orange-600"
                        : cvssScore >= 4.0
                          ? "border-l-yellow-500"
                          : "border-l-blue-500"
                    : "border-l-gray-500";

                return (
                  <div
                    key={`severity-${index}-${severityItem?.type}`}
                    className={`bg-gray-50 dark:bg-gray-800 rounded-lg p-5 border-l-4 ${borderColor} border border-gray-200 dark:border-gray-700`}
                  >
                    <div className="flex items-start justify-between gap-4 mb-3">
                      <div className="flex-1">
                        <div className="flex items-baseline gap-2 mb-1">
                          <span className="text-3xl font-bold text-gray-900 dark:text-white">
                            {cvssScore !== null ? cvssScore.toFixed(1) : "â€”"}
                          </span>
                          {cvssScore !== null && (
                            <span className="text-sm text-gray-500 dark:text-gray-400">
                              / 10.0
                            </span>
                          )}
                        </div>
                        <p className="text-sm text-gray-600 dark:text-gray-400">
                          {severityItem?.type || "CVSS Score"}
                        </p>
                      </div>
                      {cvssScore !== null && (
                        <div
                          className={`w-16 h-16 rounded-full ${scoreColor} flex items-center justify-center shrink-0`}
                        >
                          <span className="text-white text-xs font-semibold">
                            {cvssScore >= 9.0
                              ? "Critical"
                              : cvssScore >= 7.0
                                ? "High"
                                : cvssScore >= 4.0
                                  ? "Moderate"
                                  : "Low"}
                          </span>
                        </div>
                      )}
                    </div>
                    {severityItem?.score && (
                      <div className="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">
                        <p className="text-xs text-gray-500 dark:text-gray-400 mb-1">
                          Vector String
                        </p>
                        <p className="text-xs text-gray-700 dark:text-gray-300 font-mono break-all bg-white dark:bg-gray-900/50 rounded p-2">
                          {formatCVSSVector(severityItem.score)}
                        </p>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {vulnerability.details && (
          <div>
            <h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-3">
              Details
            </h2>
            <div className="text-base text-gray-900 dark:text-gray-200 prose prose-invert max-w-none bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
              <ReactMarkdown
                remarkPlugins={[remarkGfm]}
                rehypePlugins={[rehypeRaw]}
              >
                {vulnerability.details}
              </ReactMarkdown>
            </div>
          </div>
        )}

        {vulnerability.affected && !!vulnerability?.affected?.length && (
          <div>
            <h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-3">
              Affected Packages
            </h2>
            <div className="space-y-4">
              {vulnerability.affected.map((affected, index) => (
                <div
                  key={`affected-${index}-${affected?.package?.name}`}
                  className="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700"
                >
                  <div className="flex items-center gap-2 mb-3">
                    <HiCube
                      className="w-5 h-5 text-gray-500 dark:text-gray-400"
                      aria-label="Package icon"
                    />
                    <span className="font-semibold text-base text-gray-900 dark:text-white">
                      {affected.package?.name || "Unknown"}
                    </span>
                    {affected.package?.ecosystem && (
                      <span className="px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg text-sm font-medium">
                        {affected.package.ecosystem}
                      </span>
                    )}
                  </div>
                  {affected.ranges && !!affected?.ranges?.length && (
                    <div className="mt-3 space-y-2">
                      <h3 className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        Version Ranges:
                      </h3>
                      {affected.ranges.map((range) => (
                        <div
                          key={`range-${index}-${range?.repo}`}
                          className="text-sm text-gray-600 dark:text-gray-400 bg-white dark:bg-gray-900/50 rounded p-2"
                        >
                          <span className="font-medium">Version Range:</span>{" "}
                          {formatVersionRange(range)}
                        </div>
                      ))}
                    </div>
                  )}
                  {affected.versions && !!affected?.versions?.length && (
                    <div className="mt-3 text-sm text-gray-600 dark:text-gray-400 bg-white dark:bg-gray-900/50 rounded p-2">
                      <span className="font-medium">Affected Versions:</span>{" "}
                      {affected.versions.join(", ")}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        )}

        {vulnerability.references && !!vulnerability?.references?.length && (
          <div>
            <h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-3">
              References
            </h2>
            <div className="space-y-2">
              {vulnerability.references.map((ref) => (
                <Link
                  key={ref.url}
                  href={ref.url || "/"}
                  rel="noopener noreferrer"
                  className="flex items-center gap-2 text-base text-blue-600 dark:text-blue-400 hover:underline bg-gray-50 dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                  prefetch={false}
                >
                  <HiArrowTopRightOnSquare
                    className="w-5 h-5 shrink-0"
                    aria-label="External link"
                  />
                  <span className="break-all">{ref.url}</span>
                  {ref.type && (
                    <span className="px-2 py-1 bg-blue-200 dark:bg-blue-700 text-blue-800 dark:text-blue-200 rounded text-xs shrink-0">
                      {ref.type}
                    </span>
                  )}
                </Link>
              ))}
            </div>
          </div>
        )}

        {vulnerability.aliases && !!vulnerability?.aliases?.length && (
          <div>
            <h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-3">
              Aliases
            </h2>
            <div className="flex flex-wrap gap-2">
              {vulnerability.aliases.map((alias) => (
                <span
                  key={alias}
                  className="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm text-gray-700 dark:text-gray-300 font-medium"
                >
                  {alias}
                </span>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};
