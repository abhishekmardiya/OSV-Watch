import Link from "next/link";
import { HiArrowLeft } from "react-icons/hi2";
import { getVulnerabilities } from "@/actions";
import { VulnerabilityDetail } from "@/components/VulnerabilityDetail";
import type {
  OSVVulnerability,
  VulnerabilityDetailContentProps,
} from "@/types";
import { NoVulnFound } from "./NoVulnFound";

export const VulnerabilityDetailContent = async ({
  params,
  searchParams,
}: VulnerabilityDetailContentProps) => {
  const { id } = await params;
  const decodedId = decodeURIComponent(id);

  const { ecosystem, packageName, packageVersion } = await searchParams;

  let vulnerability: OSVVulnerability | undefined;

  if (packageName && packageVersion && ecosystem) {
    const { vulnerabilities } = await getVulnerabilities(
      packageVersion,
      packageName,
      ecosystem
    );
    vulnerability = vulnerabilities?.find((vuln) => {
      const cveId =
        vuln.aliases?.find((alias) => alias.startsWith("CVE-")) || vuln.id;
      return vuln.id === decodedId || cveId === decodedId;
    });
  }

  const backHref =
    packageName && packageVersion && ecosystem
      ? `/?ecosystem=${encodeURIComponent(ecosystem)}&package=${encodeURIComponent(packageName)}&version=${encodeURIComponent(packageVersion)}`
      : "/";

  if (!vulnerability) {
    return (
      <>
        <Link
          href={backHref}
          className="inline-flex items-center gap-2 text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 mb-6 transition-colors"
        >
          <HiArrowLeft className="w-5 h-5" />
          <span className="font-medium">Back to Search</span>
        </Link>
        <NoVulnFound />
      </>
    );
  }

  return (
    <>
      <Link
        href={backHref}
        className="inline-flex items-center gap-2 text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 mb-6 transition-colors"
      >
        <HiArrowLeft className="w-5 h-5" />
        <span className="font-medium">Back to Search</span>
      </Link>
      <VulnerabilityDetail vulnerability={vulnerability} />
    </>
  );
};
